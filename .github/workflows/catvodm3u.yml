name: Fetch CatVod M3U via Proxy (Up to 600, Batch Fetch with Retry)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest
    env:
      URL: https://iptv.catvod.com/tv.m3u
      OUTPUT: catvod.m3u
      OKHTTP_UA: "okhttp/4.47"
      TVBOX_UA: "okhttp/4.47 (Linux; Android 9; TVBox)"
      APP_VERSION: "4.47"
      PLATFORM: "android-tv"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch proxy list
        run: |
          echo "Fetching HTTP proxy list from Proxifly..."
          PROXY_LIST_URL="https://cdn.jsdelivr.net/gh/proxifly/free-proxy-list@main/proxies/protocols/http/data.json"
          curl -s "$PROXY_LIST_URL" -o /tmp/all_proxies.json || (echo "Failed to download proxy list" && exit 1)
          jq -r '.[0:600] | .[] | "\(.ip):\(.port)"' /tmp/all_proxies.json > /tmp/test_proxies.txt
          echo "Proxies saved to /tmp/test_proxies.txt (count: $(wc -l < /tmp/test_proxies.txt))"

      - name: Batch validation and fetch (OkHttp headers)
        run: |
          set -uo pipefail

          LIGHT_URL="https://www.google.com/generate_204"
          CONNECT_URL="https://www.google.com/generate_204"
          OUTPUT_FILE="$OUTPUT"

          BATCH_SIZE=50
          TOTAL_PROXIES=$(wc -l < /tmp/test_proxies.txt || echo 0)
          if [ "$TOTAL_PROXIES" -eq 0 ]; then
            echo "No proxies available. Exiting."
            exit 1
          fi
          BATCHES=$(( (TOTAL_PROXIES + BATCH_SIZE - 1) / BATCH_SIZE ))
          FETCH_SUCCESS=false

          for ((i=0;i<BATCHES;i++)); do
            echo "Processing batch $((i+1)) of $BATCHES"
            START=$(( i * BATCH_SIZE + 1 ))
            END=$(( START + BATCH_SIZE - 1 ))
            sed -n "${START},${END}p" /tmp/test_proxies.txt > /tmp/batch.txt

            LIGHT_OK_FILE="/tmp/light_ok.txt"
            > "$LIGHT_OK_FILE"
            while read -r PROXY; do
              if curl --silent --fail --max-time 5 -x "http://$PROXY" "$LIGHT_URL" > /dev/null 2>&1; then
                echo "$PROXY" >> "$LIGHT_OK_FILE"
                echo "âœ… Light OK: $PROXY"
              fi
              sleep 0.2
            done < /tmp/batch.txt

            BATCH_WORKING="/tmp/batch_working.txt"
            > "$BATCH_WORKING"
            while read -r PROXY; do
              if curl --silent --fail --head --max-time 5 -x "http://$PROXY" "$CONNECT_URL" > /dev/null 2>&1; then
                echo "$PROXY" >> "$BATCH_WORKING"
              fi
              sleep 0.3
            done < "$LIGHT_OK_FILE"

            if [ ! -s "$BATCH_WORKING" ]; then
              echo "No valid proxies in this batch, moving on."
              continue
            fi

            while [ -s "$BATCH_WORKING" ]; do
              PROXY=$(head -n1 "$BATCH_WORKING")
              echo "Trying proxy for fetch: $PROXY"

              if curl --fail --connect-timeout 15 --max-time 30 -x "http://$PROXY" -L --compressed \
                  -H "User-Agent: ${TVBOX_UA}" \
                  -H "Accept: application/x-mpegURL,application/vnd.apple.mpegurl,text/plain,*/*" \
                  -H "Accept-Encoding: gzip, deflate, br" \
                  -H "Connection: keep-alive" \
                  -H "X-App-Version: ${APP_VERSION}" \
                  -H "X-Platform: ${PLATFORM}" \
                  -o "${OUTPUT_FILE}.tmp" "$URL"; then
                echo "âœ… Successfully fetched via $PROXY"
                mv "${OUTPUT_FILE}.tmp" "$OUTPUT_FILE"
                FETCH_SUCCESS=true
                break 2
              else
                echo "âŒ Failed with proxy $PROXY"
                sed -i '1d' "$BATCH_WORKING"
                rm -f "${OUTPUT_FILE}.tmp" || true
              fi
            done
          done

          if [ "$FETCH_SUCCESS" = false ]; then
            echo "ðŸš¨ All proxies exhausted â€” unable to fetch M3U."
            exit 1
          fi

      - name: Patch EXTM3U header
        run: |
          sed -i '1s|^#EXTM3U.*|#EXTM3U x-tvg-url="https://epg.catvod.com/epg.xml"|' "$OUTPUT"
          head -n 1 "$OUTPUT"

      - name: Commit & push if updated
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT" || true

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update catvod.m3u [auto]"
            git push origin HEAD:main
          fi
