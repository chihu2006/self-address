name: Fetch BINGCHA M3U via Proxy

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # 3Ô∏è‚É£ Fetch proxies
      - name: Fetch proxies
        run: |
          mkdir -p /tmp/proxies

          # SOCKS5
          curl -s "https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=socks5&proxy_format=protocolipport&format=json&timeout=20000" -o /tmp/proxies/socks5.json || echo "Warning: SOCKS5 fetch failed"
          jq -r '.[] | "\(.ip):\(.port)"' /tmp/proxies/socks5.json > /tmp/proxies/socks5.txt || echo ""

          # SOCKS4
          curl -s "https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=socks4&proxy_format=protocolipport&format=json&timeout=20000" -o /tmp/proxies/socks4.json || echo "Warning: SOCKS4 fetch failed"
          jq -r '.[] | "\(.ip):\(.port)"' /tmp/proxies/socks4.json > /tmp/proxies/socks4.txt || echo ""

          # HTTP
          curl -s "https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=http&proxy_format=protocolipport&format=json&timeout=20000" -o /tmp/proxies/http.json || echo "Warning: HTTP fetch failed"
          jq -r '.[] | "\(.ip):\(.port)"' /tmp/proxies/http.json > /tmp/proxies/http.txt || echo ""

          echo "‚úÖ Proxies fetched"

      # 4Ô∏è‚É£ Set environment variables
      - name: Set environment variables
        run: |
          echo "URL=https://fy.188766.xyz/?ip=192.168.1.2&proxy=true&lunbo=false&bconly=true" >> $GITHUB_ENV
          echo "OUTPUT=bingcha.m3u" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Verify proxies
      - name: Verify proxies
        run: |
          mkdir -p /tmp/verified_proxies
          TEST_URL="$URL"

          PROXY_TYPES=("socks5" "socks4" "http")
          for TYPE in "${PROXY_TYPES[@]}"; do
            INPUT_FILE="/tmp/proxies/${TYPE}.txt"
            OUTPUT_FILE="/tmp/verified_proxies/${TYPE}.txt"
            [ -f "$INPUT_FILE" ] || continue

            echo "üîç Testing $TYPE proxies..."
            > "$OUTPUT_FILE"
            while read -r PROXY; do
              [ -z "$PROXY" ] && continue
              case "$TYPE" in
                socks5) PREFIX="socks5h://";;
                socks4) PREFIX="socks4a://";;
                http)   PREFIX="http://";;
              esac

              if curl -sS --max-time 15 -x "$PREFIX$PROXY" -I "$TEST_URL" | grep -q "200"; then
                echo "$PROXY" >> "$OUTPUT_FILE"
                echo "‚úÖ $TYPE proxy works: $PROXY"
              else
                echo "‚ùå $TYPE proxy failed: $PROXY"
              fi
            done < "$INPUT_FILE"
          done

      # 6Ô∏è‚É£ Rotate verified proxies to fetch M3U
      - name: Fetch M3U using verified proxies
        run: |
          success=false
          PROXY_TYPES=("socks5" "socks4" "http")

          for TYPE in "${PROXY_TYPES[@]}"; do
            FILE="/tmp/verified_proxies/${TYPE}.txt"
            [ -f "$FILE" ] || continue

            echo "üöÄ Fetching using verified $TYPE proxies..."
            while read -r PROXY; do
              [ -z "$PROXY" ] && continue
              case "$TYPE" in
                socks5) PREFIX="socks5h://";;
                socks4) PREFIX="socks4a://";;
                http)   PREFIX="http://";;
              esac

              if curl -sS --max-time 25 -x "$PREFIX$PROXY" -A "curl/8.13.0" -o "$OUTPUT" "$URL"; then
                if grep -q -m1 '^#EXTM3U' "$OUTPUT"; then
                  echo "‚úÖ M3U fetch success with $TYPE proxy $PROXY"
                  success=true
                  break 2
                else
                  echo "‚ö†Ô∏è Not a valid M3U, skipping..."
                fi
              else
                echo "‚ùå Proxy failed: $PROXY"
              fi
            done < "$FILE"
          done

          if [ "$success" != true ]; then
            echo "‚ùå All proxies failed."
            exit 1
          fi

      # 7Ô∏è‚É£ Commit & push updated M3U
      - name: Commit & push
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$OUTPUT"
          git diff --quiet && git diff --staged --quiet || git commit -m "Update bingcha.m3u [$(date -u '+%Y-%m-%d %H:%M:%S')]"
          git push origin HEAD:main
