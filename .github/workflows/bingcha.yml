name: Fetch BINGCHA M3U via Proxy

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl

      # 3Ô∏è‚É£ Fetch proxies
      - name: Fetch proxies
        run: |
          mkdir -p /tmp/proxies /tmp/verified_proxies

          # SOCKS5
          curl -s "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=socks5&timeout=10000&country=all&ssl=all&anonymity=all" -o /tmp/proxies/socks5.txt || echo "Warning: SOCKS5 fetch failed"

          # SOCKS4
          curl -s "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=socks4&timeout=10000&country=all&ssl=all&anonymity=all" -o /tmp/proxies/socks4.txt || echo "Warning: SOCKS4 fetch failed"

          # HTTP
          curl -s "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=http&timeout=10000&country=all&ssl=all&anonymity=all" -o /tmp/proxies/http.txt || echo "Warning: HTTP fetch failed"

          echo "‚úÖ Proxies fetched:"
          echo "   SOCKS5: $(wc -l < /tmp/proxies/socks5.txt)"
          echo "   SOCKS4: $(wc -l < /tmp/proxies/socks4.txt)"
          echo "   HTTP:   $(wc -l < /tmp/proxies/http.txt)"

      # 4Ô∏è‚É£ Set variables
      - name: Set environment variables
        run: |
          echo "URL=https://fy.188766.xyz/?ip=192.168.1.2&proxy=true&lunbo=false&bconly=true" >> $GITHUB_ENV
          echo "OUTPUT=bingcha.m3u" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Verify proxies
      - name: Verify proxies
        run: |
          PROXY_TYPES=("socks5" "socks4" "http")
          for TYPE in "${PROXY_TYPES[@]}"; do
            IN_FILE="/tmp/proxies/${TYPE}.txt"
            OUT_FILE="/tmp/verified_proxies/${TYPE}.txt"
            > "$OUT_FILE"
            total=0
            verified=0
            failed=0

            [ -f "$IN_FILE" ] || continue

            echo "üîç Verifying $TYPE proxies (Total: $(wc -l < "$IN_FILE"))..."
            while read -r PROXY; do
              [ -z "$PROXY" ] && continue
              total=$((total+1))
              case "$TYPE" in
                socks5) PREFIX="socks5h://";;
                socks4) PREFIX="socks4a://";;
                http)   PREFIX="http://";;
              esac

              if curl -s --max-time 3000 -x "$PREFIX$PROXY" -I https://www.google.com > /dev/null 2>&1; then
                echo "$PROXY" >> "$OUT_FILE"
                verified=$((verified+1))
              else
                failed=$((failed+1))
              fi
            done < "$IN_FILE"

            echo "‚úÖ $TYPE verified: $verified/$total, failed: $failed"
          done

      # 6Ô∏è‚É£ Fetch M3U with verified proxies
      - name: Fetch M3U via verified proxies
        run: |
          success=false
          PROXY_TYPES=("socks5" "socks4" "http")

          for TYPE in "${PROXY_TYPES[@]}"; do
            FILE="/tmp/verified_proxies/${TYPE}.txt"
            [ -f "$FILE" ] || continue

            echo "üöÄ Trying $TYPE proxies..."
            while read -r PROXY; do
              [ -z "$PROXY" ] && continue
              case "$TYPE" in
                socks5) PREFIX="socks5h://";;
                socks4) PREFIX="socks4a://";;
                http)   PREFIX="http://";;
              esac

              echo "‚Üí Trying $TYPE proxy $PROXY"
              if curl -sS --max-time 25 -x "$PREFIX$PROXY" -A "curl/8.13.0" -o "$OUTPUT" "$URL"; then
                if grep -q -m1 '^#EXTM3U' "$OUTPUT"; then
                  echo "‚úÖ Success with $TYPE proxy $PROXY"
                  success=true
                  break 2
                else
                  echo "‚ö†Ô∏è Not a valid M3U, skipping..."
                fi
              else
                echo "‚ùå Proxy failed: $PROXY"
              fi
            done < "$FILE"
          done

          if [ "$success" != true ]; then
            echo "‚ùå All proxies failed to fetch M3U."
            exit 1
          fi

      # 7Ô∏è‚É£ Commit & push updated M3U
      - name: Commit & push
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT"
          git diff --quiet && git diff --staged --quiet || git commit -m "Update bingcha.m3u [$(date -u '+%Y-%m-%d %H:%M:%S')]"
          git push origin HEAD:main
