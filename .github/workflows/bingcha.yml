name: Fetch BINGCHA M3U via Proxy

on:
  schedule:
    - cron: "0 0 * * *"  # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Get proxy list from ProxyScrape
      - name: Download proxy list
        run: |
          # Request only SOCKS5 proxies (most reliable for curl + remote DNS)
          API_URL='https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=socks5&proxy_format=ipport&format=text'
          curl -sS --max-time 40 "$API_URL" -o /tmp/proxies.txt || { echo "Failed to download proxy list"; exit 1; }
          echo "Downloaded $(wc -l < /tmp/proxies.txt) proxies"

      # 3. Set other environment variables
      - name: Set variables
        run: |
          echo "URL=https://fy.188766.xyz/?ip=192.168.1.2&proxy=true&lunbo=false&bconly=true" >> $GITHUB_ENV
          echo "OUTPUT=bingcha.m3u" >> $GITHUB_ENV

      # 4. Fetch M3U, rotating through proxies
      - name: Fetch M3U with rotating proxies
        run: |
          echo "Starting M3U fetch with rotating proxies..."

          success=false
          attempt=0
          max_attempts=100   # how many proxies to try at most

          while read -r ipport && [ $attempt -lt $max_attempts ]; do
            [ -z "$ipport" ] && continue
            attempt=$((attempt+1))

            PROXY="socks5h://$ipport"
            echo "[$attempt] Trying proxy $PROXY"

            if curl --fail --max-time 30 -x "$PROXY" -L -A "curl/8.13.0" -o "$OUTPUT" "$URL"; then
              if [ -s "$OUTPUT" ]; then
                echo "M3U fetch completed successfully using $PROXY"
                success=true
                break
              else
                echo "Downloaded file is empty, trying next proxy..."
              fi
            else
              echo "Proxy $PROXY failed, trying next..."
            fi

          done < /tmp/proxies.txt

          if [ "$success" != true ]; then
            echo "❌ All tested proxies failed after $attempt attempts."
            exit 1
          fi

      # 5. Commit & push if bingcha.m3u updated
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $OUTPUT
          git diff --quiet && git diff --staged --quiet || git commit -m "Update bingcha.m3u"
          git push origin HEAD:main
