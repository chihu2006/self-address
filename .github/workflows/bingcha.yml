name: Fetch BINGCHA M3U via Proxy

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl

      # 3Ô∏è‚É£ Fetch proxies (plain text)
      - name: Fetch proxies
        run: |
          mkdir -p /tmp/proxies

          # SOCKS5
          curl -s "https://api.proxyscrape.com/v4/free-proxy-list/?type=socks5&anon=elite&timeout=2000&country=all&format=txt" -o /tmp/proxies/socks5.txt || echo "Warning: SOCKS5 fetch failed"

          # SOCKS4
          curl -s "https://api.proxyscrape.com/v4/free-proxy-list/?type=socks4&anon=elite&timeout=2000&country=all&format=txt" -o /tmp/proxies/socks4.txt || echo "Warning: SOCKS4 fetch failed"

          # HTTP
          curl -s "https://api.proxyscrape.com/v4/free-proxy-list/?type=http&anon=elite&timeout=2000&country=all&format=txt" -o /tmp/proxies/http.txt || echo "Warning: HTTP fetch failed"

          echo "‚úÖ Proxies fetched: SOCKS5=$(wc -l < /tmp/proxies/socks5.txt), SOCKS4=$(wc -l < /tmp/proxies/socks4.txt), HTTP=$(wc -l < /tmp/proxies/http.txt)"

      # 4Ô∏è‚É£ Set environment variables
      - name: Set environment variables
        run: |
          echo "URL=https://fy.188766.xyz/?ip=192.168.1.2&proxy=true&lunbo=false&bconly=true" >> $GITHUB_ENV
          echo "OUTPUT=bingcha.m3u" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Verify and rotate proxies
      - name: Verify and fetch M3U
        run: |
          success=false
          PROXY_TYPES=("socks5" "socks4" "http")

          for TYPE in "${PROXY_TYPES[@]}"; do
            FILE="/tmp/proxies/${TYPE}.txt"
            [ -f "$FILE" ] || continue

            TOTAL=$(wc -l < "$FILE")
            VERIFIED=0
            FAILED=0
            echo "üîç Verifying $TYPE proxies (Total: $TOTAL)..."

            while read -r PROXY; do
              [ -z "$PROXY" ] && continue

              case "$TYPE" in
                socks5) PREFIX="socks5h://";;
                socks4) PREFIX="socks4a://";;
                http)   PREFIX="http://";;
              esac

              if curl -sS --max-time 25 -x "$PREFIX$PROXY" -A "curl/8.13.0" -o "$OUTPUT" "$URL"; then
                if grep -q -m1 '^#EXTM3U' "$OUTPUT"; then
                  VERIFIED=$((VERIFIED+1))
                  echo "‚úÖ Success with $TYPE proxy $PROXY"
                  success=true
                  break 2
                else
                  FAILED=$((FAILED+1))
                fi
              else
                FAILED=$((FAILED+1))
              fi
            done < "$FILE"

            echo "‚úÖ $TYPE verified: $VERIFIED/$TOTAL, failed: $FAILED"

          done

          if [ "$success" != true ]; then
            echo "‚ùå All proxies failed to fetch M3U."
            exit 1
          fi

      # 6Ô∏è‚É£ Commit & push updated M3U
      - name: Commit & push
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$OUTPUT"
          git diff --quiet && git diff --staged --quiet || git commit -m "Update bingcha.m3u [$(date -u '+%Y-%m-%d %H:%M:%S')]"
          git push origin HEAD:main
