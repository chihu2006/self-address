name: Fetch CatVod M3U via Proxy (Proxifly Edition)

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "URL=https://live.catvod.com/tv.m3u" >> $GITHUB_ENV
          echo "OUTPUT=catvod.m3u" >> $GITHUB_ENV

      - name: Fetch and validate proxies
        run: |
          echo "Fetching proxy list from Proxifly (HTTP only)..."
          PROXY_LIST_URL="https://cdn.jsdelivr.net/gh/proxifly/free-proxy-list@main/proxies/protocols/http/data.json"
          curl -s "$PROXY_LIST_URL" -o /tmp/proxies.json

          echo "Selecting top 10 proxies for testing..."
          jq -r '.[0:10] | .[] | "\(.ip):\(.port)"' /tmp/proxies.json > /tmp/proxies.txt

          echo "Testing up to 10 proxies..."
          URL_TO_TEST="https://httpbin.org/ip"
          WORKING_PROXY=""

          while read PROXY; do
            echo "Testing proxy: $PROXY"
            if curl --silent --fail --max-time 10 -x "http://$PROXY" "$URL_TO_TEST" > /dev/null; then
              echo "‚úÖ Proxy $PROXY works!"
              WORKING_PROXY="$PROXY"
              break
            else
              echo "‚ùå Proxy $PROXY failed."
            fi
          done < /tmp/proxies.txt

          if [ -z "$WORKING_PROXY" ]; then
            echo "üö® No working proxies found. Exiting."
            exit 1
          fi

          echo "Using working proxy: $WORKING_PROXY"
          echo "PROXY=$WORKING_PROXY" >> $GITHUB_ENV

      - name: Fetch M3U via working proxy
        run: |
          echo "Fetching M3U via proxy $PROXY..."
          if curl --fail --retry 3 --retry-delay 5 --max-time 30 \
              -x "http://$PROXY" -L -A "curl/8.13.0" -o "$OUTPUT" "$URL"; then
            echo "‚úÖ M3U fetched successfully."
          else
            echo "üö® Failed to download M3U."
            exit 1
          fi

      - name: Patch EXTM3U header
        run: |
          sed -i '1s|^#EXTM3U.*|#EXTM3U x-tvg-url="https://epg.catvod.com/epg.xml"|' "$OUTPUT"
          head -n 1 "$OUTPUT"

      - name: Commit & push if updated
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT"
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update catvod.m3u [auto]"
            git push origin HEAD:main
          fi
