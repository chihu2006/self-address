name: Fetch catvod M3U via Proxy

on:
  schedule:
    - cron: "0 0 * * *"  # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Fetch proxy from pubproxy.com
      - name: Fetch proxy
        run: |
          mkdir -p /tmp
          echo "Fetching proxy from PubProxy..."
          PROXY_JSON=$(curl -s "http://pubproxy.com/api/proxy?limit=1&format=json")
          echo "Raw proxy JSON: $PROXY_JSON"
          
          PROXY=$(echo $PROXY_JSON | jq -r '.data[0].ip + ":" + .data[0].port')
          echo "Selected proxy: $PROXY"
          
          echo "PROXY=$PROXY" >> $GITHUB_ENV

      # 3. Set URL & OUTPUT variables
      - name: Set URL & output
        run: |
          echo "URL=https://live.catvod.com/tv.m3u" >> $GITHUB_ENV
          echo "OUTPUT=catvod.m3u" >> $GITHUB_ENV

      # 4. Fetch M3U using curl via proxy
      - name: Fetch M3U via curl
        run: |
          echo "Fetching M3U via proxy $PROXY..."
          for i in {1..10}; do
            curl --fail --retry 10 --retry-delay 5 -x "http://$PROXY" -L -A "curl/8.13.0" -o $OUTPUT $URL && break
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          if [ ! -s $OUTPUT ]; then
            echo "Error: Downloaded file is empty or incomplete."
            exit 1
          fi

          echo "M3U fetch completed successfully."

      # 5. Patch EXTM3U line
      - name: Patch EXTM3U header
        run: |
          sed -i '1s|^#EXTM3U.*|#EXTM3U x-tvg-url="https://epg.catvod.com/epg.xml"|' $OUTPUT
          head -n 1 $OUTPUT
          
      # 6. Commit & push if updated
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $OUTPUT
          git diff --quiet && git diff --staged --quiet || git commit -m "Update catvod.m3u"
          git push origin HEAD:main
