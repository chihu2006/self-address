name: Fetch CatVod M3U via Proxy (Improved)

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-m3u:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Set URL and output variables
      - name: Set environment variables
        run: |
          echo "URL=https://live.catvod.com/tv.m3u" >> $GITHUB_ENV
          echo "OUTPUT=catvod.m3u" >> $GITHUB_ENV

      # 3. Fetch multiple HTTP proxies from PubProxy
      - name: Fetch proxies
        run: |
          echo "Fetching up to 5 HTTP proxies from PubProxy..."
          PROXY_JSON=$(curl -s "http://pubproxy.com/api/proxy?limit=5&format=json&type=http")
          echo "Proxy list received:"
          echo "$PROXY_JSON" | jq '.data[] | {ip: .ip, port: .port}'
          
          echo "$PROXY_JSON" > /tmp/proxies.json

      # 4. Attempt to fetch the M3U file using the proxy list
      - name: Download M3U using available proxies
        run: |
          URL=${URL}
          OUTPUT=${OUTPUT}
          echo "Attempting to download $URL with fallback proxies..."

          for PROXY in $(jq -r '.data[] | "\(.ip):\(.port)"' /tmp/proxies.json); do
            echo "Trying proxy: $PROXY"
            if curl --fail --retry 3 --retry-delay 5 --max-time 15 \
                -x "http://$PROXY" -L -A "curl/8.13.0" -o "$OUTPUT" "$URL"; then
              echo "‚úÖ Successfully downloaded using proxy: $PROXY"
              echo "PROXY=$PROXY" >> $GITHUB_ENV
              break
            else
              echo "‚ùå Proxy $PROXY failed, trying next..."
            fi
          done

          if [ ! -s "$OUTPUT" ]; then
            echo "üö® All proxies failed. Exiting."
            exit 1
          fi

          echo "‚úÖ M3U fetch completed successfully."

      # 5. Patch the EXTM3U header with EPG link
      - name: Patch EXTM3U header
        run: |
          OUTPUT=${OUTPUT}
          sed -i '1s|^#EXTM3U.*|#EXTM3U x-tvg-url="https://epg.catvod.com/epg.xml"|' "$OUTPUT"
          echo "Updated EXTM3U header:"
          head -n 1 "$OUTPUT"

      # 6. Commit and push changes if the file has been updated
      - name: Commit & push if updated
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update catvod.m3u [auto]"
            git push origin HEAD:main
          fi
