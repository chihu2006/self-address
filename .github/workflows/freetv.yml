name: Verify IPTV streams

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: sudo apt-get install -y ffmpeg

      - name: Run IPTV checker
        run: |
          echo "🔍 Verifying IPTV streams using ffprobe..."

          input="rawaddress/freetv.m3u"
          verified="rawaddress/verified_freetv.m3u"
          failed="rawaddress/failed_freetv.m3u"

          mkdir -p rawaddress
          touch "$verified" "$failed"

          i=0
          while read -r url; do
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            ((i++))
            echo "[$i] Checking stream: $url"

            if timeout 15s ffprobe -v error -show_entries stream=codec_type -of default=nw=1:nk=1 "$url" > /dev/null 2>&1; then
              echo "✅ OK ($url)"
              echo "$url" >> "$verified"
            else
              echo "❌ FAILED ($url)"
              echo "$url" >> "$failed"
            fi
          done < "$input"

          echo "✅ Verification done: $(wc -l < "$verified") passed, $(wc -l < "$failed") failed."

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add rawaddress/freetv.m3u rawaddress/verified_freetv.m3u rawaddress/failed_freetv.m3u
          git commit -m "Update freetv.m3u verification results" || echo "No changes to commit"
          git push
          fi
