name: Fetch & Verify IPTV M3U (Top N Channels)

on:
  schedule:
    - cron: "0 0 * * *"  # Run daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-verify:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Set environment variables
      - name: Set variables
        run: |
          echo "URL=https://freetv.fun/test_channels_banned_cn_new.m3u" >> $GITHUB_ENV
          echo "OUTPUT=rawaddress/freetv.m3u" >> $GITHUB_ENV
          echo "TEST_FILE=rawaddress/test_channels.m3u" >> $GITHUB_ENV
          echo "FAILED_OUTPUT=rawaddress/failed_freetv.m3u" >> $GITHUB_ENV
          echo "LOG_FILE=rawaddress/verification_log.txt" >> $GITHUB_ENV
          echo "CHANNEL_LIMIT=50" >> $GITHUB_ENV   # Change this number to test more channels later

      # 3. Prepare output directory
      - name: Prepare folder
        run: mkdir -p rawaddress

      # 4. Fetch M3U
      - name: Fetch M3U via curl
        run: |
          echo "Fetching M3U from $URL..."
          for i in {1..5}; do
            curl --fail --retry 5 --retry-delay 5 -L -A "Chrome/140.0.0.0" -o "$OUTPUT" "$URL" && break
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          if [ ! -s "$OUTPUT" ]; then
            echo "❌ Error: Downloaded file is empty or incomplete."
            exit 1
          fi
          echo "✅ M3U fetched successfully."

      # 5. Install dependencies
      - name: Install ffmpeg & iptv-checker
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          npm install -g iptv-checker

      # 6. Extract top N channels for testing
      - name: Extract top N channels
        run: |
          echo "#EXTM3U" > "$TEST_FILE"
          awk '/^#EXTINF/{print;getline;print}' "$OUTPUT" | head -n $((CHANNEL_LIMIT * 2)) >> "$TEST_FILE"
          count=$(grep -c '^http' "$TEST_FILE" || echo 0)
          echo "✅ Extracted $count channels for verification."

      # 7. Verify selected channels
      - name: Verify top channels and save log
        run: |
          input="$TEST_FILE"
          failed="$FAILED_OUTPUT"
          log="$LOG_FILE"
          : > "$failed"
          : > "$log"

          total=$(grep -c '^http' "$input" || echo 0)
          echo "🔍 Verifying top $total channels..." | tee -a "$log"
          echo "----------------------------------------" | tee -a "$log"

          # Run iptv-checker and save output
          iptv-checker "$input" 2>&1 | tee -a "$log"

          echo "" | tee -a "$log"
          echo "----------------------------------------" | tee -a "$log"

          # Extract failed or timeout URLs
          grep -E '^(FAILED|TIMEOUT)' "$log" | awk '{print $NF}' > "$failed" || true

          failed_count=$(grep -c '^http' "$failed" || echo 0)

          echo "" | tee -a "$log"
          echo "🎯 Verification complete!" | tee -a "$log"
          echo "   Total checked: $total" | tee -a "$log"
          echo "   Failed/Timeout: $failed_count" | tee -a "$log"
          echo "   Failed list saved to: $failed" | tee -a "$log"
          echo "----------------------------------------" | tee -a "$log"

      # 8. Commit & push results
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $OUTPUT $TEST_FILE $FAILED_OUTPUT $LOG_FILE
          git diff --quiet && git diff --staged --quiet || git commit -m "Update IPTV verification results"
          git push origin HEAD:main
