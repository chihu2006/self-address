name: Fetch & Verify freetv M3U (Failed Only, with Logs)

on:
  schedule:
    - cron: "0 0 * * *"  # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-filter-failed:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Set environment variables
      - name: Set variables
        run: |
          echo "URL=https://freetv.fun/test_channels_banned_cn_new.m3u" >> $GITHUB_ENV
          echo "RAW_DIR=rawaddress" >> $GITHUB_ENV
          echo "RAW_FILE=freetv.m3u" >> $GITHUB_ENV
          echo "FAILED_FILE=verified_freetv.m3u" >> $GITHUB_ENV

      # 3. Fetch M3U
      - name: Fetch M3U
        run: |
          mkdir -p $RAW_DIR
          echo "Fetching M3U from $URL..."
          for i in {1..5}; do
            curl --fail --retry 5 --retry-delay 5 -L -A "Chrome/140.0.0.0" -o "$RAW_DIR/$RAW_FILE" "$URL" && break
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          if [ ! -s "$RAW_DIR/$RAW_FILE" ]; then
            echo "‚ùå Error: Downloaded file is empty or incomplete."
            exit 1
          fi

          echo "‚úÖ M3U fetched successfully."

      # 4. Speed test & log results
      - name: Verify and collect failed streams
        run: |
          echo "üîç Verifying stream URLs..."
          RAW_PATH="$RAW_DIR/$RAW_FILE"
          FAILED_PATH="$RAW_DIR/$FAILED_FILE"
          > "$FAILED_PATH"

          # Copy header if present
          awk '/^#EXTM3U/ { print $0 }' "$RAW_PATH" > "$FAILED_PATH"

          TOTAL=$(grep -c '^http' "$RAW_PATH" || true)
          COUNT=0
          FAILED=0
          WORKING=0

          # Pair #EXTINF with next URL and test each
          awk 'NR==FNR{if(/^#EXTINF/){title=$0}else if(/^http/){print title"\n"$0}}' "$RAW_PATH" "$RAW_PATH" | while read -r line; do
            if [[ "$line" == \#EXTINF* ]]; then
              INFO="$line"
            elif [[ "$line" == http* ]]; then
              COUNT=$((COUNT+1))
              echo "[$COUNT/$TOTAL] Testing: $line"

              # Run HTTP test with timeout (5s)
              START_TIME=$(date +%s%3N)
              HTTP_CODE=$(curl -m 5 -s -o /dev/null -w "%{http_code}" "$line" || echo "000")
              END_TIME=$(date +%s%3N)
              ELAPSED=$((END_TIME - START_TIME))

              if echo "$HTTP_CODE" | grep -qE '^2..$'; then
                echo "‚úÖ OK [$HTTP_CODE] (${ELAPSED}ms)"
                WORKING=$((WORKING+1))
              else
                echo "‚ùå FAILED [$HTTP_CODE] (${ELAPSED}ms)"
                echo "$INFO" >> "$FAILED_PATH"
                echo "$line" >> "$FAILED_PATH"
                FAILED=$((FAILED+1))
              fi
            fi
          done

          echo ""
          echo "===== üìä SUMMARY ====="
          echo "Total URLs checked: $TOTAL"
          echo "Working channels:   $WORKING"
          echo "Failed channels:    $FAILED"
          echo "======================"
          echo "‚ùå Failed results saved to: $FAILED_PATH"

      # 5. Commit & push if updated
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rawaddress/freetv.m3u rawaddress/verified_freetv.m3u
          git diff --quiet && git diff --staged --quiet || git commit -m "Update freetv.m3u and failed verified_freetv.m3u"
          git push origin HEAD:main
          fi
